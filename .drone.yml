---
kind: pipeline
type: docker
name: linux-amd64

platform:
  arch: amd64
  os: linux

steps:
- name: publish
  image: plugins/docker
  pull: if-not-exists
  settings:
    registry: gitea:3000
    repo: gitea:3000/${DRONE_REPO}
    mirror: http://127.0.0.1:5000
    insecure: true
    cache_from: gitea.kanis.dev/${DRONE_REPO}:latest
    dockerfile:
      from_secret: docker_file
    auto_tag: true
    auto_tag_suffix: linux-amd64
    squash: true
    compress: true
    username: bkanis
    password:
      from_secret: gitea_password
  when:
    event:
    - push
    - tag
    - promote

---
kind: pipeline
type: docker
name: manifest-plugin

steps:
  - name: push to docker manifest
    image: plugins/manifest
    settings: 
      username: bkanis
      password:
        from_secret: gitea_password
      target: "gitea.kanis.dev/${DRONE_REPO}:latest"
      template: "gitea.kanis.dev/${DRONE_REPO}:OS-ARCH"
      platforms:
        - linux/amd64
        - linux/arm64
      ignore_missing: true

trigger:
  event:
  - push
  - tag
  - promote

depends_on:
- linux-amd64